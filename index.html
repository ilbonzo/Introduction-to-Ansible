<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Introduction to Ansible</title>
    <link rel="stylesheet" type="text/css" href="build/build.css">
  </head>
  <body>
    <article>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h1>Introduction to DevOps with Ansible</h1>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Matteo Magni</h2>
        <h3><a href="http://bit.ly/devops-ansible">http://bit.ly/devops-ansible</a></h3><img style="width: 25%" src="images/officina-linux.jpg" />
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>In informatica <strong>DevOps</strong> (dalla contrazione inglese di development, "sviluppo", e operations, qui simile a "messa in produzione" o "deployment") è una metodologia di sviluppo del software che punta alla comunicazione, collaborazione e integrazione tra sviluppatori e addetti alle operations dell'information technology (IT)</h3><em>[wikipedia]</em>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3><em>Con il termine “Metodologie Agili” ci si riferisce ad una serie di metodologie di sviluppo software ispirate dal “Manifesto Agile”, impiegate per superare i limiti emersi dal modello tradizionale “a cascata” (waterfall).</em></h3><em>[wikipedia]</em>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Tra le pratiche Agili una è quella di avere frequenti rilasci di nuove versioni del software:<br><br><em>An Agile team frequently releases its product into the hands of end users, listening to feedback, whether critical or appreciative..</em></h3><em>[wikipedia]</em>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Rilasci</h2>
        <ul>
          <li></li>
          <li>In molte aziende però i rilasci applicativi sono eventi ad alto impatto e rischio, coinvolgendo più gruppi di lavoro.</li>
          <li>L’obiettivo è mettere in produzione nuove feature o correzioni di bug il più velocemente possibile e con il minor numero di rischi è molto difficile</li>
        </ul>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <ul>
          <li>I <strong>dev</strong> spingono per mettere subito online le nuove feature</li>
          <li>i <strong>QA</strong> inoltrano</li>
          <li>gli <strong>operation</strong> sono molto prudenti perché sanno che toccare l’infrastruttura potrebbe creare problemi.</li>
        </ul>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-image"><img class="full" src="images/dev-qa-ops.gif" /></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Come possiamo fare?</h2>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <ul>
          <li>Sviluppare e testare in ambienti simili a quelli di produzione</li>
          <li>Distribuire con processi automatici, ripetibili e affidabili</li>
          <li>Monitorare e convalidare la qualità operativa</li>
          <li>Amplificare e accelerare il ritorno di feedback da parte degli utenti</li>
        </ul>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Continuous integration e testing</h2>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Continuous delivery e deployment</h2>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Continuous operations</h2>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Continuous assessment</h2>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-image"><img class="full" src="images/devops_cycle.png" /></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-image"><img class="full" src="images/devops.png" /></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>L’utilizzo di pratiche <strong>DevOps</strong> spesso parte dal bisogno di poter creare, gestire, condividere e replicare configurazioni di ambienti complessi</h3>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <p>Se pensiamo ad una infrastruttura web come ad esempio lo stack LAMP in una soluzione dove abbiamo più ambienti</p>
        <ul>
          <li></li>
          <li><strong>Development</strong></li>
          <li><strong>Testing</strong></li>
          <li><strong>Staging</strong></li>
          <li><strong>Production</strong></li>
        </ul>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-image"><img class="full" src="images/dev-stage-prod.gif" /></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <ul>
          <li>Quando devo aggiungere una nuova dipendenza di infrastruttura?</li>
          <li>Un nuovo pacchetto?</li>
          <li>Un nuovo servizio?</li>
        </ul>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-image">
        <h2><em>developer</em></h2><img class="full" src="images/developer-fear.gif" />
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <p><em>La metodologia <strong>DevOps</strong> aiuta le aziende nella gestione dei rilasci, standardizzando gli ambienti di sviluppo.</em><br><br><em>Le aziende con problemi di automazione dei rilasci solitamente hanno già un processo automatico in essere ma lo vorrebbero più flessibile e controllabile.</em></p>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <p><em>Idealmente tale automazione potrebbe essere utilizzata anche da risorse non operative (non appartenenti all'IT Operations) su ambienti non di produzione. In questo modo gli sviluppatori hanno a disposizione un maggiore controllo degli ambienti, dando all'infrastruttura una visione più incentrata sull'applicazione.[wikipedia]</em></p>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text"><img style="width: 50%" src="images/infrastructure_as_code_medium.png" /></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <p>Come sviluppatori siamo abituati a gestire diverse dipendenze tra componenti software (classi, package e librerie)</p>
        <p><strong><em>Ma anche le infrastrutture hanno delle dipendenze!</em></strong></p>
        <ul>
          <li></li>
          <li>File e Directory</li>
          <li>Utenti</li>
          <li>Software e loro configurazione</li>
        </ul>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <p><em>Possiamo usare un software per il controllo di versione e sfruttarne tutte le potenzialità.</em></p><strong>Git, Mercurial, Svn</strong><img style="max-width: 70%" src="images/git-diff.png" />
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <ul>
          <li><em><strong>serve qualcuno che esegua le operazioni ripetitive</strong></em></li>
          <li><img class="full" src="images/stupid-bird.gif" /></li>
        </ul>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Ansible</h2>
        <h3><a href="https://www.ansible.com">https://www.ansible.com</a></h3>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text"><em>"Deploy apps. Manage systems. Crush complexity.</em><em>Ansible helps you build a strong foundation for DevOps."</em></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3><a href="https://github.com/ansible/ansible">github.com/ansible/ansible</a>
          <p><br><br><strong>GNU GENERAL PUBLIC LICENSE</strong><br><em>Version 3</em></p>
        </h3>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text"><em>The name <strong>"Ansible"</strong> references a fictional instantaneous hyperspace communication system (as featured in Orson Scott Card's Ender's Game (1985), and originally invented by Ursula K. Le Guin for her novel Rocannon's World (1966)).</em></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text"><em>debian</em>
        <pre><code class="language-bash">$ deb http://ppa.launchpad.net/ansible/ansible/ubuntu trusty main
$ sudo apt-get update
$ sudo apt-get install ansible</code></pre><em>fedora</em>
        <pre><code class="language-bash">$ sudo dnf -y install ansible</code></pre><em>Pip</em>
        <pre><code class="language-bash">$ pip install ansible
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Dipendenze</h3>
        <ul>
          <li>Python</li>
          <li>ssh</li>
        </ul>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text"><em>Ansible works by connecting to your nodes and pushing out small programs, called "Ansible modules" to them. These programs are written to be resource models of the desired state of the system. Ansible then executes these modules (over SSH by default), and removes them when finished.</em></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>YAML</h3><em><strong>YAML</strong>: YAML Ain't Markup Language</em><em><strong>What It Is</strong>: YAML is a human friendly data serialization standard for all programming languages.</em><a href="http://yaml.org/">yaml.org</a>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <pre><code class="language-yaml">galaxy_info:
author: Matteo Magni
description: just another geek
license: license Apache 2.0
platforms:
  - name: Debian
    versions:
    - jessie
categories:
  - system
dependencies: []
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-image">
        <ul>
          <li>
            <h2>Ansible glossary</h2>
          </li>
          <li>Inventory</li>
          <li>Tasks</li>
          <li>Variables</li>
          <li>Roles</li>
          <li>Handlers</li>
          <li>Playbook</li>
        </ul>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Inventory</h2>
        <pre><code class="language-yaml">[databases]
stp.ilbonzo.net     ansible_ssh_user=scott

[webservers]
aic.ilbonzo.net     ansible_ssh_user=layne
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Tasks</h2>
        <pre><code class="language-yaml">- name: add group devel
  group: name=devel state=present
- name: Apache | install apache
  apt: name=apache2 state=latest
  </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Variables</h2>
        <pre><code class="language-yaml">user: vagrant
group: www-data
document_root: /var/www/officina-linux.it
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Handlers</h2>
        <pre><code class="language-yaml">- name: restart postgresql
  service: name=postgresql state=restarted
- name: stop postgresql
  service: name=postgresql state=stopped
- name: start postgresql
  service: name=postgresql state=started
  </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Roles</h2>
        <pre><code class="language-yaml">╰─➤  ls -l database
  total 0
  drwxr-xr-x  10 bonzo  staff  340 Dec  6 10:45 files
  drwxr-xr-x  10 bonzo  staff  340 Dec  6 10:45 handlers
  drwxr-xr-x  10 bonzo  staff  340 Dec  6 10:45 tasks
  drwxr-xr-x   5 bonzo  staff  170 Dec  6 10:45 templates
  </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Playbook</h2>
        <pre><code class="language-yaml">- hosts: all
  sudo: true
  handlers:
    - include: handlers/main.yml
  pre_tasks:
    - name: update apt cache
      shell: apt-get update
    - name: upgrade apt
      shell: apt-get upgrade -y
  roles:
    - webserver
    - database
- include: nfs.yml
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Ansible Galaxy</h2>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-image"><img class="full" src="images/ansible-galaxy.png" /></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text"><img style="width: 60%" src="images/minecraft.svg" /></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Galaxy role</h3><a href="https://github.com/ilbonzo/ansible-minecraft">github.com/ilbonzo/ansible-minecraft</a>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-image"><img class="full" src="images/vagrant-ansible-minecraft.png" /></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-image"><img class="full" src="images/vagrant-ansible-minecraft-2.png" /></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-image"><img style="width:80%" src="images/virtual-box.png" /></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-image"><img class="full" src="images/minecraft-1.png" /></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-image"><img class="full" src="images/minecraft-2.png" /></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text"><iframe width="560" height="315" src="https://www.youtube.com/embed/ICAlhy4EI44" frameborder="0" allowfullscreen></iframe><br><a href="https://youtu.be/ICAlhy4EI44">https://youtu.be/ICAlhy4EI44</a></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Iniziamo a provare</h3>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Virtualizzare può essere d'aiuto per sperimentare e non solo</h3>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <ul>
          <li>Ci serve qualcuno che ci metta a disposizione semplicemente delle Virtual Machine.</li>
          <li>Potrebbe essere un qualsiasi sistema di cloud.</li>
          <li>In sviluppo possiamo usare <strong>Vagrant</strong></li>
        </ul>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Vagrant</h2><em>"Create and configure lightweight, reproducible, and portable development environments."</em><a href="https://www.vagrantup.com/">vagrantup.com</a>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Provider</h2>
        <ul>
          <li>
            <h3>Virtualbox</h3>
          </li>
          <li>
            <h3>VMware</h3>
          </li>
          <li>
            <h3>Hyper-V</h3>
          </li>
          <li>
            <h3>Docker</h3>
          </li>
        </ul>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>commands</h2>
        <ul>
          <li>
            <h4>$ vagrant init</h4>
          </li>
          <li>
            <h4>$ vagrant up</h4>
          </li>
          <li>
            <h4>$ vagrant halt</h4>
          </li>
          <li>
            <h4>$ vagrant reload</h4>
          </li>
          <li>
            <h4>$ vagrant destroy</h4>
          </li>
        </ul>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Vagrantfile</h3>
        <pre><code class="language-yaml">Vagrant.configure("2") do |config|
  config.vm.box = "base"
end
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Vagrant Box</h2>
        <p><a href="https://www.vagrantup.com/intro/getting-started/boxes.html">https://www.vagrantup.com/intro/getting-started/boxes.html</a></p>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Vagrant Box</h2>
        <pre><code class="language-yaml">$ vagrant box list
$ vagrant box add debian/jessie64
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Vagrant Box</h3>
        <pre><code class="language-yaml">Vagrant.configure("2") do |config|
  config.vm.box = "debian/jessie64"
end
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Vagrant Networking</h3>
        <pre><code class="language-yaml">config.vm.hostname = "rocannon"
config.vm.network :forwarded_port, guest: 80, host: 8080
config.vm.network "private_network", ip: "192.168.33.66"
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Vagrant ssh login</h3>
        <pre><code class="language-yaml">$ vagrant ssh
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Testing port forwarding</h3>
        <pre><code class="language-yaml">$ vagrant ssh
$ echo pippo42 > index.html
$ sudo python -m SimpleHTTPServer 80
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Attivare ssh "normale"</h3>
        <p><em>config.ssh.forward_agent</em></p>
        <p><em>If true, agent forwarding over SSH connections is enabled. Defaults to false.</em></p>
        <pre><code class="language-yaml">config.ssh.forward_agent = true
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Debian login ssh con password</h3>
        <p><em><strong>$ sudo vi /etc/ssh/sshd_config</strong></em></p>
        <pre><code class="language-yaml">PasswordAuthentication yes</code></pre>
        <p><em><strong>$ sudo service ssh restart</strong></em></p>
        <p>ora possiamo entrare nella macchina in ssh "classico"</p>
        <p><em><strong>ssh vagrant@192.168.33.66</strong></em></p>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Provider configuration</h2>
        <h3>Virtualbox</h3>
        <pre><code class="language-yaml">config.vm.provider "virtualbox" do |v|
  v.name = "rocannon-debian"
  v.memory = 512
  v.cpus = 2
end
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Provisioning</h2>
        <h3>Ansible</h3>
        <pre><code class="language-yaml">config.vm.provision "shell",
  inline: "sudo apt-get -y update && sudo apt-get -y install lynx"
  </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Run provisioning with vagrant</h2>
        <pre><code class="language-yaml">$ vagrant up #first time when create a machines

$ vagrant up --provision

$ vagrant provision
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Provisioning</h2>
        <h3>Ansible</h3>
        <pre><code class="language-yaml">config.vm.provision :ansible do |ansible|
  ansible.groups = {
    "development" => ["default"],
    "all_groups:children" => ["development"]
    
  }
  ansible.playbook = "ansible/playbook.yml"
end
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>First playbook</h2>
        <pre><code class="language-yaml">- hosts: all
  become: true
  pre_tasks:
    - name: update apt cache
      command: apt-get -y update
      
  tasks:
    - name: install lynx
      command: apt-get install -y lynx
      
  post_tasks:
    - name: hostname
      command: hostname
      </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Provisioning</h2>
        <h3>with Ansible on windows</h3>
        <pre><code class="language-yaml">## if you don't want ansible on host
config.vm.provision :shell, :path => "ansible/provision.sh"
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Provisioning</h2>
        <h3>Ansible on windows</h3>
        <pre><code class="language-yaml">#!/bin/bash
sudo apt-get update
sudo apt-get install -y python-pip python-dev python-pycurl
sudo pip install ansible
sudo mkdir -p /etc/ansible
printf '[vagrant]\nlocalhost\n' | sudo tee /etc/ansible/hosts > /dev/null
echo Running provisioner: ansible
PYTHONUNBUFFERED=1 ansible-playbook -c local /workspace/tools/ansible/playbook.yml
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Version Control System</h2>
        <h3>(VCS)</h3>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-image"><img class="full" src="images/git-model.png" /></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Git for versioning</h2><a href="http://rogerdudler.github.io/git-guide/">http://rogerdudler.github.io/git-guide/</a>
        <a href="http://rogerdudler.github.io/git-guide/files/git_cheat_sheet.pdf">http://rogerdudler.github.io/git-guide/files/git_cheat_sheet.pdf</a>
        <p>Our git repository</p><a href="https://github.com/ilbonzo/Rocannon">https://github.com/ilbonzo/Rocannon</a>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Inventory</h2>
        <ul>
          <li>static inventory</li>
          <li>dynamic inventory</li>
        </ul>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Static Inventory</h2>
        <pre><code class="language-yaml">[databases]
stp.ilbonzo.net     ansible_user=scott

[webservers]
aic.ilbonzo.net     ansible_user=layne
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Inventory list</h2>
        <pre><code class="language-yaml">$ ansible --list-hosts web
  hosts (1):
    ilbonzo.net</code></pre>
        <pre><code class="language-yaml"># linux
$ /etc/ansible/hosts
# osx
$ /usr/local/etc/ansible/hosts
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Local inventory</h2>
        <pre><code class="language-yaml">$ ansible -i hosts --list-hosts all
  hosts (4):
    web01
    web02
    db01
    db02
    </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Subset</h2>
        <pre><code class="language-yaml">$ ansible -i hosts --list-hosts webserver
  hosts (4):
    web01
    web02
    
$ ansible -i hosts --list-hosts webserver:dbserver
  hosts (4):
    web01
    web02
    db01
    db02
    </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Local inventory</h2>
        <pre><code class="language-yaml">ansible_user=vagrant
ansible_port=2606
ansible_ssh_private_key_file=~/.ssh/id_rsa
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Vagrant local inventory</h2>
        <pre><code class="language-yaml"># Generated by Vagrant
default ansible_ssh_host=127.0.0.1
  ansible_ssh_port=2222
  ansible_ssh_user='vagrant'
  ansible_ssh_private_key_file=
    '~/.vagrant/machines/default/virtualbox/private_key'
    
[development]
default

[all_groups:children]
development
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Running command</h2>
        <pre><code class="language-yaml">$ ansible -i ansible/hosts -m ping all -k
    SSH password:
    192.168.33.66 | SUCCESS => {
        "changed": false,
        "ping": "pong"
    }
    
$ ansible -i ansible/hosts -m command -a "hostname" all -k
    SSH password:
    192.168.33.66 | SUCCESS | rc=0 >>
    rocannon
    
$ ansible -i ansible/hosts -a "hostname" all -k
    SSH password:
    192.168.33.66 | SUCCESS | rc=0 >>
    rocannon
    </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Vagrantfile</h3>
        <pre><code class="language-yaml">config.vm.provision :ansible do |ansible|
  ansible.groups = {
    "development" => ["default"],
    "all_groups:children" => ["development"]
    
  }
  ansible.playbook = "ansible/playbook.yml"
end
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Playbook</h2>
        <pre><code class="language-yaml">---
- hosts: all
  tasks:
    - name: install lynx
      command: apt-get install -y linux
    - command: hostname
    </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-image"><img class="full" src="images/playbook-output.png" /></section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Running playbook</h2>
        <pre><code class="language-yaml">$ ansible-playbook ansible/playbook.yml -i hosts --ask-sudo-pass --ask-pass
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Modules</h2>
        <p><em>Modules (also referred to as “task plugins” or “library plugins”) are the ones that do the actual work in ansible, they are what gets executed in each playbook task. But you can also run a single one using the ‘ansible’ command.</em></p><a href="http://docs.ansible.com/ansible/modules_by_category.html">http://docs.ansible.com/ansible/modules_by_category.html</a>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Packaging: apt</h2>
        <p><em>Manages apt packages (such as for Debian/Ubuntu).</em></p><a href="http://docs.ansible.com/ansible/apt_module.html">http://docs.ansible.com/ansible/apt_module.html</a>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>module apt</h2>
        <pre><code class="language-yaml">pre_tasks:
  - name: update apt cache
    apt: update_cache=yes
    
tasks:
  - name: install lynx
    apt: name=lynx state=latest
    </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>apt</h2>
        <pre><code class="language-yaml">tasks:
  - name: install apache2
    apt: name=apache2 state=latest update_cache=yes
    </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>become</h2>
        <h3>privilege escalation</h3>
        <p><em>Ansible allows you to ‘become’ another user, different from the user that logged into the machine (remote user). This is done using existing privilege escalation tools, which you probably already use or have configured, like sudo, su, pfexec, doas, pbrun, dzdo, ksu and others.</em></p><a href="http://docs.ansible.com/ansible/become.html">http://docs.ansible.com/ansible/become.html</a>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>become</h2>
        <pre><code class="language-yaml">tasks:
  - name: Run a command as the apache user
    command: somecommand
    become: true
    become_user: apache
    </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Loops</h2><a href="http://docs.ansible.com/ansible/playbooks_loops.html">http://docs.ansible.com/ansible/playbooks_loops.html</a>
        <pre><code class="language-yaml">tasks:
  - name: install lynx
    apt: name=lynx state=latest
  - name: install vim
    apt: name=vim state=latest
    </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Loops</h2><a href="http://docs.ansible.com/ansible/playbooks_loops.html">http://docs.ansible.com/ansible/playbooks_loops.html</a>
        <pre><code class="language-yaml">tasks:
  - name: install packages
    apt: name={{ item }} state=latest
    with_items:
    - lynx
    - vim
    </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Jinja2</h2>
        <h3>Templating</h3><a href="http://docs.ansible.com/ansible/playbooks_templating.html">http://docs.ansible.com/ansible/playbooks_templating.html</a>
        <pre><code class="language-yaml">- name: touch files with an optional mode
  file: dest={{item.path}} state=touch mode={{item.mode|default(omit)}}
  with_items:
    - path: /tmp/foo
    - path: /tmp/bar
    - path: /tmp/baz
      mode: "0444"
      </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Service</h2>
        <p><em>Controls services on remote hosts. Supported init systems include BSD init, OpenRC, SysV, Solaris SMF, systemd, upstart.</em></p><a href="http://docs.ansible.com/ansible/service_module.html">http://docs.ansible.com/ansible/service_module.html</a>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Service</h2>
        <pre><code class="language-yaml">- name: install apache2
  apt: name=apache2 state=latest update_cache=yes
- name: apache2 is running
  service: name=apache2 state=started enabled=yes
  </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Include Statements</h2>
        <p><em>"single responsibility principle"</em></p>
        <pre><code class="language-yaml">- include: webserver.yml
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Handlers</h2>
        <p><em>Handlers are lists of tasks, not really any different from regular tasks, that are referenced by a globally unique name, and are notified by notifiers. If nothing notifies a handler, it will not run. Regardless of how many tasks notify a handler, it will run only once, after all of the tasks complete in a particular play.</em></p>
        <pre><code class="language-yaml">- handlers:
  - name: restart apache2
    service: name=apache2 state=restarted
    </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Notify to Handlers</h2>
        <pre><code class="language-yaml">- name: check mod rewrite
  apache2_module:
    state: present
    name: rewrite
  notify:
  - restart apache2
  </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Demo App</h2>
        <h3>Flask framework</h3><a href="http://flask.pocoo.org/">http://flask.pocoo.org/</a>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>webserver.yml</h2>
        <pre><code class="language-yaml">---
- hosts: all
  become: true
  tasks:
  
    - name: install apache2 and other components
      apt: name={{ item }} state=present update_cache=yes
      with_items:
        - apache2
        - libapache2-mod-wsgi
        - python-pip
        - python-virtualenv
        
    - name: ensure apache is started
      service: name=apache2 state=started enabled=yes
      
    - name: ensure mod_wsgi enabled
      apache2_module: state=present name=wsgi
      notify: restart apache2
      
  handlers:
    - name: restart apache2
      service: name=apache2 state=restarted
      </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Copy modules</h2>
        <p>source copied from control machine to server</p><a href="https://docs.ansible.com/ansible/copy_module.html">https://docs.ansible.com/ansible/copy_module.html</a>
        <pre><code class="language-yaml">- name: copy demo app source
  copy: src=../demo/app/ dest=/var/www/demo mode=755
  notify: restart apache2
  </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Copy modules</h2>
        <p>apache virtual hosts</p>
        <pre><code class="language-yaml">- name: copy virtual host config
  copy: src=../demo/demo.conf dest=/etc/apache2/sites-available mode=755
  notify: restart apache2
  </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Pip modules</h2>
        <pre><code class="language-yaml">- name: setup python virtualenv
  pip:
    requirements=/var/www/demo/requirements.txt
    virtualenv=/var/www/demo/.venv
  notify: restart apache2
  </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Handlers</h2>
        <pre><code class="language-yaml">RUNNING HANDLER [restart apache2] ******************
changed: [default]
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Flush Handlers</h2>
        <pre><code class="language-yaml">- meta: flush_handlers
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Files module</h2>
        <h3>symlink</h3><a href="https://docs.ansible.com/ansible/file_module.html">https://docs.ansible.com/ansible/file_module.html</a>
        <pre><code class="language-yaml">- name: de-activate default apache site
  file: path=/etc/apache2/sites-enabled/000-default.conf state=absent
  notify: restart apache2
- name: activate demo apache site
  file:
    src=/etc/apache2/sites-available/demo.conf
    dest=/etc/apache2/sites-enabled/demo.conf
    state=link
  notify: restart apache2
  </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>View demo app</h2><a href="http://localhost:4444">http://localhost:4444/</a>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>MySql db module</h2><a href="https://docs.ansible.com/ansible/mysql_db_module.html">https://docs.ansible.com/ansible/mysql_db_module.html</a>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>MySql user module</h2><a href="https://docs.ansible.com/ansible/mysql_user_module.html">https://docs.ansible.com/ansible/mysql_user_module.html</a>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>webserver.yml</h2>
        <pre><code class="language-yaml">---
- hosts: all
  become: true
  tasks:
  - name: install apache2 and other components
    apt: name={{ item }} state=present update_cache=yes
    with_items:
      ...
      - python-mysqldb
      </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>database.yml</h2>
        <pre><code class="language-yaml">---
- hosts: all
  become: true
  tasks:
  
    - name: install mysql-server
      apt:
        name=mysql-server
        state=present
        update_cache=yes
        
    - name: ensure mysql is started
      service:
        name=mysql
        state=started
        enabled=yes
        
  handlers:
    - name: restart mysql
      service: name=mysql state=restarted
      </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>line in line module</h2>
        <pre><code class="language-yaml">- name: ensure mysql listen on all ports
  lineinfile:
    dest=/etc/mysql/my.cnf
    regexp=^bind-address
    line="bind-address = 0.0.0.0"
  notify: restart mysql
  </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Mysql create db</h2>
        <pre><code class="language-yaml">- name: create demo database
  mysql_db: name=demo state=present
  </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Mysql create user</h2>
        <pre><code class="language-yaml">- name: create demo user
  mysql_user:
    name=demo
    password=demo
    priv=demo.*:ALL host='%'
    state=present
    </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>View demo app db</h2><a href="http://localhost:4444/db">http://localhost:4444/db</a>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Db down</h2>
        <pre><code class="language-yaml">$ sudo service mysql stop
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Nginx - loadbalancer</h2>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>loadbalancer.yml</h3>
        <pre><code class="language-yaml">---
- hosts: loadbalancer
  become: true
  tasks:
  
    - name: install nginx
      apt: name={{ item }} state=present update_cache=yes
      with_items:
        - nginx
        
    - name: ensure nginx is started
      service: name=nginx state=started enabled=yes
      
  handlers:
    - name: restart nginx
      service: name=nginx state=restarted
      </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Vagrant multi machine</h2><a href="https://www.vagrantup.com/docs/multi-machine/">https://www.vagrantup.com/docs/multi-machine/</a>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Vagrantfile - multi machine</h3>
        <pre><code class="language-yaml">config.vm.define "web" do |web|
  web.vm.box = "debian/jessie64"
  web.vm.hostname = "rocannon-web"
end

config.vm.define "db" do |db|
  db.vm.box = "debian/jessie64"
  db.vm.hostname = "rocannon-db"
end

config.vm.define "lb" do |lb|
  lb.vm.box = "debian/jessie64"
  lb.vm.hostname = "rocannon-lb"
end
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Multi machine provisioning</h3>
        <pre><code class="language-yaml">config.vm.provision :ansible do |ansible|
  ansible.groups = {
    "webserver" => ["web"],
    "dbserver" => ["db"],
    "loadbalancer" => ["lb"],
    "all_groups:children" => ["development"]
    
  }
  ansible.playbook = "ansible/playbook.yml"
end
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Inventory for multi machine</h3>
        <pre><code class="language-yaml">[webserver]
web1

[dbserver]
db

[loadbalancer]
lb
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Vagrant command for multi machine</h3>
        <pre><code class="language-yaml">$ vagrant ssh [machine]
$ vagrant provision [machine]
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Change playbook hosts</h3>
        <pre><code class="language-yaml">- hosts: webserver
- hosts: dbserver
- hosts: loadbalancer
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Verify</h3>
        <h4>App</h4><a href="http://localhost:4444/">http://localhost:4444/</a>
        <a href="http://localhost:4444/db">http://localhost:4444/db</a>
        <h4>Nginx</h4><a href="http://localhost:4445/">http://localhost:4445/</a>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Web to db connection</h2>
        <pre><code class="language-yaml"># demo.wsgi
os.environ['DATABASE_URI'] = 'mysql://demo:demo@192.168.33.67/demo'

# or
os.environ['DATABASE_URI'] = 'mysql://demo:demo@192.168.33.67/demo'
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>/etc/hosts</h3>
        <pre><code class="language-yaml">- name: edit etc hosts
  lineinfile:
    path: /etc/hosts
    state: present
    line: '192.168.33.67 db'
    </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Templates</h2>
        <p>templates/nginx.conf.j2</p>
        <pre><code class="language-yaml">upstream web {
  {% for server in groups.webserver %}
      server {{ server }};
  {% endfor %}
}

server {
    listen 80;
    
    location / {
        proxy_pass http://web;
    }
}
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Templates</h2>
        <p>loadbalancer.yml</p>
        <pre><code class="language-yaml">- name: edit /etc/hosts
  lineinfile:
    path: /etc/hosts
    state: present
    line: '192.168.33.66 web'
    
- name: config nginx site
  template:
    src=templates/nginx.conf.j2
    dest=/etc/nginx/sites-available/demo
    mode=0644
  notify: restart nginx
  
- name: de-activate default nginx site
  file: path=/etc/nginx/sites-enabled/default state=absent
  notify: restart nginx
  
- name: activate demo nginx site
  file:
    src=/etc/nginx/sites-available/demo.conf
    dest=/etc/nginx/sites-enabled/demo
    state=link
  notify: restart nginx
  </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Vagrantfile - multi machine</h3>
        <pre><code class="language-yaml">config.vm.define "web1" do |web1|
  web1.vm.box = "debian/jessie64"
  web1.vm.hostname = "rocannon-web-1"
end
config.vm.define "web2" do |web2|
  web2.vm.box = "debian/jessie64"
  web2.vm.hostname = "rocannon-web-2"
end
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>Vagrantfile - multi machine</h3>
        <h3>provisioning</h3>
        <pre><code class="language-yaml">config.vm.provision :ansible do |ansible|
  ansible.groups = {
    "webserver" => ["web1" , "web2"],
    "dbserver" => ["db"],
    "loadbalancer" => ["lb"],
    "all_groups:children" => ["development"]
    
  }
  ansible.playbook = "ansible/playbook.yml"
end
</code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>loadbalancer.yml</h3>
        <pre><code class="language-yaml">- name: edit /etc/hosts
  lineinfile:
    path: /etc/hosts
    state: present
    line: "{{ item.ip }} {{ item.name }}"
  with_items:
    - { ip: 192.168.33.65, name: web1 }
    - { ip: 192.168.33.66, name: web2 }
    </code></pre>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Roles</h2>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Variables</h2>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>end</h2>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h3>fonti</h3>
        <ul>
          <li><a href="https://www.ansible.com">ansible.com</a></li>
          <li><a href="http://devops.com">devops.com</a></li>
          <li><a href="http://github.com">github.com</a></li>
          <li><a href="http://devopsreactions.tumblr.com/">devopsreactions.tumblr.com</a></li>
          <li><a href="http://losviluppatore.it/">losviluppatore.it</a></li>
          <li><a href="https://www.ibuildings.it/">buildings.it</a></li>
        </ul>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h1>Questions?</h1>
      </section>
      <section data-bespoke-backdrop="emphatic" class="emphatic-text">
        <h2>Thanks to</h2>
        <h3><a href="http://officina-linux.it/">officina-linux.it</a></h3><img style="width: 45%" src="images/officina-linux.jpg" />
      </section>
    </article>
    <script src="build/build.js"></script>
  </body>
</html>